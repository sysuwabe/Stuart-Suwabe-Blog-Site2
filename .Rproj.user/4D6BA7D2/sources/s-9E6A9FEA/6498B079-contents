---
title: Food Insecurity Code - Analysis
author: R package build
date: '2021-08-04'
categories:
  - R
tags:
  - regression
  - R Markdown
slug: food-insecurity-code-analysis
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidycensus)
```

```{r}
# census_api_key("41dcf38aad5e9257d3d377a226d8f5ce88274d23")

PubTransBelPov <- get_acs(geography = "county", variables = "B08122_014", state = "CA", year = 2019)
PubTransBelPov1 <- PubTransBelPov %>% rename(county = NAME, PubTransBelPov = estimate) %>% select(county, PubTransBelPov)
PubTransInPov <- get_acs(geography = "county", variables = "B08122_015", state = "CA", year = 2019)
PubTransInPov1 <- PubTransInPov %>% rename(county = NAME, PubTransInPov = estimate) %>% select(county, PubTransInPov)
# number of people in poverty that take public transportation in the really low and mid-poverty percentiles 

# basically add them both together
PubTransPov <- merge(PubTransBelPov1, PubTransInPov1, by = "county")
PubTransData <- PubTransPov %>% mutate(PubTransPov = PubTransBelPov + PubTransInPov) %>% select(c(county, PubTransPov))

FoodAssist <- get_acs(geography = "county", variables = "B09010_002", state = "CA", year = 2019)
FoodAssist1 <- FoodAssist %>% rename(county = NAME, FoodAssist = estimate) %>% select(county, FoodAssist)
# number of people who rely on SSI, food stamps, or other support

EduHSBelow <- get_acs(geography = "county", variables = "B06009_002", state = "CA", year = 2019)
EduHSBelow1 <- EduHSBelow %>% rename(county = NAME, EduHSBelow = estimate) %>% select(county, EduHSBelow)
# number of people not graduated high school

EduHSGrad <- get_acs(geography = "county", variables = "B06009_003", state = "CA", year = 2019)
EduHSGrad1 <- EduHSGrad %>% rename(county = NAME, EduHSGrad = estimate) %>% select(county, EduHSGrad)
# number of people who graduated high school

EduSomeCol <- get_acs(geography = "county", variables = "B06009_004", state = "CA", year = 2019)
EduSomeCol1 <- EduSomeCol %>% rename(county = NAME, EduSomeCol = estimate) %>% select(county, EduSomeCol)
# number of people with some college

EduBach <- get_acs(geography = "county", variables = "B06009_005", state = "CA", year = 2019)
EduBach1 <- EduBach %>% rename(county = NAME, EduBach = estimate) %>% select(county, EduBach)
# number of people with a Bachelor's Degree

x19test2 <- merge(foodin19a, PubTransData, by = "county")
x19test3 <- merge(x19test2, FoodAssist1, by = "county")
x19test4 <- merge(x19test3, EduHSBelow1, by = "county")
x19test5 <- merge(x19test4, EduHSGrad1, by = "county")
x19test6 <- merge(x19test5, EduSomeCol1, by = "county")
x19test7 <- merge(x19test6, EduBach1, by = "county")

foodinca <- x19test7[-c(1:3,6:9,11,12,16)]

# I had to do my own research for how many food pantries are in each county. This is inconclusive and most certainly inaccurate since data for this doesn't exist, but I think having this data is important. 
foodinca$pantry_num <- c(20,20,15,49,15,6,54,8,12,41,8,16,13,17,30,28,38,7,30,10,11,3,10,8,4,11,30,9,10,95,33,9,41,37,6,111,39,30,42,42,12,53,25,13,11,5,5,25,16,30,14,3,4,21,11,190,60,12)
```


After my exploratory data analysis, I decided to log my output variable for both data sets. 

```{r}
# I take out these columns because of potential leakage. 
foodincaPercen1 <- foodincaPercen %>% mutate(l_insecure_percen = log(insecure_percen)) %>% rename(budget_shortfall = `2019 Weighted Annual Food Budget Shortfall`) %>% select(-c(1,3,4)) 

foodincaNum1 <- foodincaNum %>% mutate(l_insecure_num = log(insecure_num)) %>% rename(budget_shortfall = `2019 Weighted Annual Food Budget Shortfall`) %>% select(-c(1,3,4))
```

# Percentage model
```{r}
library(caret)

control <- trainControl(method = "boot", number = 5)

set.seed(504)
m1 <- train(l_insecure_percen ~ .,
            data = foodincaPercen1, 
            method = "lm", 
            trControl = control,
            preProcess = c("BoxCox", "center", "scale"))

summary(m1)

library(modelr)
rmse(m1, foodincaPercen1) 
```


# Numeric model
```{r}
set.seed(504)
m2 <- train(l_insecure_num ~ .,
            data = foodincaNum1, 
            method = "lm", 
            trControl = control,
            preProcess = c("BoxCox", "center", "scale"))

summary(m2)

library(modelr)
rmse(m2, foodincaNum1) 
```

Before I jump to conclusions, I should partition the data as well, working on smaller parts of the data set. 

```{r}
percen_index <- createDataPartition(foodincaPercen1$l_insecure_percen, p = 0.7, list = FALSE)
percen_tr <- foodincaPercen1[ percen_index, ]
percen_te <- foodincaPercen1[-percen_index, ]

num_index <- createDataPartition(foodincaNum1$l_insecure_num, p = 0.7, list = FALSE)
num_tr <- foodincaNum1[ num_index, ]
num_te <- foodincaNum1[-num_index, ]
```


# Percentage model - partitioned
```{r}
set.seed(504)
m3 <- train(l_insecure_percen ~ .,
            data = percen_tr, 
            method = "lm", 
            trControl = control,
            preProcess = c("BoxCox", "center", "scale"))

percen_pred <- predict(m3, percen_te)
postResample(pred = percen_pred, obs = percen_te$l_insecure_percen)
```

```{r}
summary(m3)
```

# Numeric model - partitioned
```{r}
set.seed(504)
m4 <- train(l_insecure_num ~ .,
            data = num_tr, 
            method = "lm", 
            trControl = control,
            preProcess = c("BoxCox", "center", "scale"))

num_pred <- predict(m4, num_te)
postResample(pred = num_pred, obs = num_te$l_insecure_num)
```

```{r}
summary(m4)
```


# The conclusions

The stars next to the coefficients showcase significant features towards the output that is the percentage of/the number of people who suffer from food insecurity. 

For the percentage data, the percentage of children who suffer from food insecurity out of all the children in the counties' population is the most statistically significant feature. 

For the numerical data, the number of people of the population who use public transportation seems to be the most recurring significant feature. 

Perhaps recurring the most out of these four model would be the percentage/number of people who only have achieved high school levels of learning, graduated or no. If you look at the fourth model, where EduHSGrad has one star of significance, that estimate means that with a unit increase of 1 for the number of people in poverty whose highest level education is graduating high school, there would be a predicted increase of 156407 people to the food insecure population. Looking at the same feature in model 3, which has no significance in comparison, if there was a 1% increase in these poverty-stricken high school grads, there would be a predicted 0.28% decrease in the food insecure population. 

There are conflicting results to all this, no doubt about it. But there are ways to interpret this. On one hand, the more people that have higher levels of education, the more the food insecurity percentage would decrease overall. As well, if that's the top level of their education without going further, food insecurity may rise as a potential result of a lack of education (leading to a lack of job variety, perhaps). Public transportation and the food budget shortfall are also big players, increasing and decreasing the food insecure population respectively. As well as the percentage of children suffering from food insecurity having an upwards impact on the insecurity rate. 


## Approach these models from a TidyModels perspective
```{r}
library(tidymodels)

set.seed(504)
data_split <- initial_split(foodincaPercen1, prop = 3/4)
percen_tr <- training(data_split)
percen_te  <- testing(data_split)

set.seed(504)
data_split <- initial_split(foodincaNum1, prop = 3/4)
num_tr <- training(data_split)
num_te  <- testing(data_split)


food_rec1 <- 
  recipe(l_insecure_percen ~ ., data = percen_tr) %>% 
  step_BoxCox(all_numeric(), -all_outcomes()) 

lm_spec <- 
  linear_reg() %>% 
  set_engine("lm")

food_wflow <- 
  workflow() %>% 
  add_model(lm_spec) %>% 
  add_recipe(food_rec1)

food_fit1 <- fit(food_wflow, percen_tr)

food_fit1 %>% ## display results
  pull_workflow_fit() %>% 
  tidy() 

```

# Evaluate model with training data
```{r}
food_pred <- predict(food_fit1, percen_te %>% select(-l_insecure_percen)) 
head(food_pred)
```

# And for the numeric data set
```{r}
food_rec2 <- 
  recipe(l_insecure_num ~ ., data = num_tr) %>% 
  step_BoxCox(all_numeric(), -all_outcomes()) 

food_wflow <- 
  workflow() %>% 
  add_model(lm_spec) %>% 
  add_recipe(food_rec2)

food_fit2 <- fit(food_wflow, num_tr)

food_fit2 %>% ## display results
  pull_workflow_fit() %>% 
  tidy() 
```

```{r}
food_pred <- predict(food_fit2, num_te %>% select(-l_insecure_num)) 
head(food_pred)
```


## Treebag model

```{r}
library(stacks)
folds1 <- vfold_cv(percen_tr, v = 3) 
folds2 <- vfold_cv(num_tr, v = 3)
metric <- metric_set(rmse)

library(baguette)

bag_spec <- 
   bag_tree() %>% 
   set_engine("rpart", times = 50L) %>% 
   set_mode("regression")

food_wflow <- 
  workflow() %>% 
  add_model(bag_spec) %>% 
  add_recipe(food_rec1)

bag_res1 <- 
  fit_resamples(
    food_wflow,
    resamples = folds1,
    metrics = metric,
    control = control_stack_resamples()
  )

bag_res1 %>% 
  collect_metrics() 

```


```{r}
food_wflow <- 
  workflow() %>% 
  add_model(bag_spec) %>% 
  add_recipe(food_rec2)

bag_res2 <- 
  fit_resamples(
    food_wflow,
    resamples = folds2,
    metrics = metric,
    control = control_stack_resamples()
  )

bag_res2 %>% 
  collect_metrics() 

```



## Random Forests model

```{r}
library(ranger)

rf_spec <- 
   rand_forest() %>% 
   set_engine("ranger") %>% 
   set_mode("regression")

food_wflow <- 
  workflow() %>% 
  add_model(rf_spec) %>% 
  add_recipe(food_rec1)

rf_res1 <- 
  fit_resamples(
    food_wflow,
    resamples = folds1,
    metrics = metric,
    control = control_stack_resamples()
  )

rf_res1 %>% 
  collect_metrics() 

```

```{r}
food_wflow <- 
  workflow() %>% 
  add_model(rf_spec) %>% 
  add_recipe(food_rec2)

rf_res2 <- 
  fit_resamples(
    food_wflow,
    resamples = folds2,
    metrics = metric,
    control = control_stack_resamples()
  )

rf_res2 %>% 
  collect_metrics() 
```




## Gradient Boosting model

```{r}
xgb_spec <- 
   boost_tree() %>% 
   set_engine("xgboost") %>% 
   set_mode("regression")

food_wflow <- 
  workflow() %>% 
  add_model(xgb_spec) %>% 
  add_recipe(food_rec1)

xgb_res1 <- 
  fit_resamples(
    food_wflow,
    resamples = folds1,
    metrics = metric,
    control = control_stack_resamples()
  )

xgb_res1 %>% 
  collect_metrics() 

```


```{r}
food_wflow <- 
  workflow() %>% 
  add_model(xgb_spec) %>% 
  add_recipe(food_rec2)

xgb_res2 <- 
  fit_resamples(
    food_wflow,
    resamples = folds2,
    metrics = metric,
    control = control_stack_resamples()
  )

xgb_res2 %>% 
  collect_metrics() 

```





## LASSO model with multiple resamples - percentage data set
```{r}

food_data_st1 <- 
  stacks() %>%
  add_candidates(bag_res1) %>%
  add_candidates(rf_res1) %>%
  add_candidates(xgb_res1)

food_model_st1 <-
  food_data_st1 %>%
  blend_predictions()

autoplot(food_model_st1, type = "weights")
```


## The fit
```{r}
food_model_st_fit1 <-
  food_model_st1 %>%
  fit_members()

food_model_st_fit1 
```


```{r}
food_pred <- predict(food_model_st_fit1, percen_te)

food_results1 <- bind_cols(food_pred, percen_te %>% select(l_insecure_percen))
head(food_results1)
```

## predict results
```{r}
food_metrics <- metric_set(rmse, rsq, mae)
food_metrics(food_results1, truth = l_insecure_percen, estimate = .pred)
```



## The same LASSO with the numeric data set

```{r}

food_data_st2 <- 
  stacks() %>%
  add_candidates(bag_res2) %>%
  add_candidates(rf_res2) %>%
  add_candidates(xgb_res2)

food_model_st2 <-
  food_data_st2 %>%
  blend_predictions()

autoplot(food_model_st2, type = "weights")
```

```{r}
food_model_st_fit2 <-
  food_model_st2 %>%
  fit_members()

food_model_st_fit2 
```


```{r}
food_pred <- predict(food_model_st_fit2, num_te)

food_results2 <- bind_cols(food_pred, num_te %>% select(l_insecure_num))
head(food_results2)
```

## predict results
```{r}
food_metrics <- metric_set(rmse, rsq, mae)
food_metrics(food_results2, truth = l_insecure_num, estimate = .pred)
```




